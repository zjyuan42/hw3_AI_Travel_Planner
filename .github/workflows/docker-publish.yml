name: Build and Push Docker Image to Alibaba Cloud

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Dockeré•œåƒç‰ˆæœ¬'
        required: true
        default: 'latest'

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: ai-travel-planner
  IMAGE_NAME: ai-travel-planner

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Alibaba Cloud Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.ALIBABA_CLOUD_USERNAME }}
        password: ${{ secrets.ALIBABA_CLOUD_PASSWORD }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Generate deployment info
      run: |
        echo "ğŸš€ Dockeré•œåƒæ„å»ºå’Œæ¨é€å®Œæˆï¼"
        echo "é•œåƒåœ°å€ï¼š${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}"
        echo "å¯ç”¨æ ‡ç­¾ï¼š${{ steps.meta.outputs.tags }}"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½é•œåƒå‘½ä»¤ï¼š"
        echo "docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
        echo ""
        echo "ğŸƒ è¿è¡Œå®¹å™¨å‘½ä»¤ï¼š"
        echo "docker run -d -p 80:5000 --name ai-travel-planner ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"

    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          README_DOCKER.md
          run-docker.sh
          run-docker.bat
          DOCKER_RUN_GUIDE.md
        body: |
          # ğŸš€ AIæ—…è¡Œè§„åˆ’å™¨ Dockeré•œåƒå‘å¸ƒ

          ## é•œåƒä¿¡æ¯
          - **é•œåƒåœ°å€**: `${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:latest`
          - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **Gitæäº¤**: ${{ github.sha }}

          ## å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¹¶è¿è¡Œä¸€é”®è„šæœ¬ï¼š
          ```bash
          # Linux/macOS
          ./run-docker.sh

          # Windows
          run-docker.bat
          ```

          2. é…ç½®APIå¯†é’¥åè®¿é—®ï¼šhttp://localhost

          ## åŠŸèƒ½ç‰¹æ€§
          - âœ… æ™ºèƒ½è¯­éŸ³è¡Œç¨‹è§„åˆ’
          - âœ… å®æ—¶åœ°å›¾å¯¼èˆª
          - âœ… è´¹ç”¨é¢„ç®—ç®¡ç†
          - âœ… ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
          - âœ… äº‘ç«¯æ•°æ®åŒæ­¥

    - name: Update Docker Hub mirror
      if: success()
      run: |
        # å¯é€‰ï¼šåŒæ—¶æ¨é€åˆ°Docker Hubä½œä¸ºå¤‡ä»½
        echo "å¦‚éœ€æ¨é€åˆ°Docker Hubï¼Œè¯·é…ç½®DOCKERHUB_USERNAMEå’ŒDOCKERHUB_TOKEN secrets"